<div class="min-h-screen bg-[#F5F5F7] text-[#1D1D1F] font-sans flex flex-col relative overflow-x-hidden">

    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-[#D2D2D7] h-16 flex-none transition-all duration-300">
        <div class="w-full h-full flex items-center justify-between px-6 max-w-[1600px] mx-auto">
            
            <div class="flex items-center gap-2 cursor-pointer" (click)="searchText=''; clearImage(); aiState.response = null; aiState.isActive = false">
                <div class="size-8 rounded-lg bg-[#0066CC] text-white flex items-center justify-center font-bold text-xl shadow-sm">
                    G
                </div>
                <span class="font-bold text-[#1D1D1F] text-lg tracking-tight">Galeri Makina</span>
            </div>

            <div class="flex items-center gap-4">
                <button (click)="isCartOpen = true" class="relative group p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <span class="material-symbols-outlined text-[#1D1D1F] group-hover:text-[#0066CC] transition-colors">shopping_cart</span>
                    @if ((cartService.totalCount$ | async) || 0 > 0) {
                        <span class="absolute top-0 right-0 size-4 bg-[#FF3B30] text-white text-[10px] font-bold flex items-center justify-center rounded-full shadow-sm transform scale-100 transition-transform">
                            {{ cartService.totalCount$ | async }}
                        </span>
                    }
                </button>

                <div class="h-4 w-px bg-[#D2D2D7]"></div>
                
                <button class="text-xs font-medium text-[#1D1D1F] hover:text-[#0066CC] transition-colors">İletişim</button>
                <button class="text-xs font-medium text-[#1D1D1F] bg-[#E5E5EA] hover:bg-[#D2D2D7] px-3 py-1.5 rounded-md transition-colors">
                    Giriş Yap
                </button>
            </div>
        </div>
    </header>

    <section class="bg-white border-b border-[#D2D2D7] py-12 px-6 relative overflow-hidden transition-all duration-500"
             [class.py-8]="aiState.isActive"> 
        <div class="max-w-4xl mx-auto relative z-10 transition-all duration-500">
            
            @if(!aiState.isActive) {
                <div class="text-center mb-8 fade-in">
                    <h1 class="text-4xl md:text-5xl font-bold text-[#1D1D1F] mb-3 tracking-tight">
                        Parça uzmanına sorun.
                    </h1>
                    <p class="text-[#86868B] text-lg">
                        Görsel yükleyin, arıza tarif edin veya parça kodu girin.
                    </p>
                </div>
            }

            <div class="relative group bg-white rounded-[24px] shadow-xl shadow-black/5 border border-[#d2d2d7] transition-all duration-300 hover:shadow-2xl hover:shadow-blue-900/5 focus-within:border-[#0066CC] focus-within:ring-4 focus-within:ring-[#0066CC]/10 overflow-hidden"
                 [class.ring-4]="aiState.isActive"
                 [class.ring-[#0066CC]/10]="aiState.isActive">

                @if(selectedImage) {
                    <div class="p-4 border-b border-gray-100 flex items-center gap-4 bg-[#F5F5F7]">
                        <div class="relative size-16 rounded-lg overflow-hidden border border-gray-200 shadow-sm">
                            <img [src]="selectedImagePreview" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <p class="text-xs font-bold text-[#0066CC]">Görsel Analizi</p>
                            <p class="text-sm text-gray-600">Parça taranıyor...</p>
                        </div>
                        <button (click)="clearImage()" class="p-2 hover:bg-white rounded-full transition-colors text-gray-500">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                }

                <div class="flex items-center p-2">
                    <div class="pl-4 pr-3 text-[#86868B]">
                        @if(aiState.isLoading) {
                            <span class="material-symbols-outlined animate-spin text-[#0066CC]">sparkles</span>
                        } @else {
                            <span class="material-symbols-outlined text-[#0066CC]">auto_awesome</span>
                        }
                    </div>

                    <input 
                        [(ngModel)]="searchText" 
                        (input)="onSearchInput()"
                        (keyup.enter)="startAiSearch()"
                        type="text" 
                        placeholder="Örn: 'Juki çağanoz', '3101801' veya fotoğraf yükle..." 
                        class="flex-1 h-14 bg-transparent border-none text-lg text-[#1D1D1F] placeholder-[#86868B] outline-none"
                    >

                    <div class="flex items-center gap-2 pr-2">
                        <label class="cursor-pointer p-2 rounded-full hover:bg-[#F5F5F7] text-[#86868B] hover:text-[#0066CC] transition-colors" title="Fotoğraf Yükle">
                            <input type="file" class="hidden" (change)="onFileSelected($event)" accept="image/*" capture="environment">
                            <span class="material-symbols-outlined">add_photo_alternate</span>
                        </label>

                        <button (click)="startAiSearch()" 
                                [disabled]="!searchText && !selectedImage"
                                class="p-2.5 rounded-xl bg-[#0066CC] text-white disabled:bg-[#E5E5EA] disabled:text-[#86868B] transition-all hover:scale-105 active:scale-95 shadow-md disabled:shadow-none">
                            <span class="material-symbols-outlined">arrow_upward</span>
                        </button>
                    </div>
                </div>
                
                @if(aiState.isLoading) {
                    <div class="h-1 w-full bg-[#E5E5EA] overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-[#0066CC] via-[#34C759] to-[#0066CC] animate-shimmer w-[200%]"></div>
                    </div>
                }
            </div>

            @if(aiState.response) {
                <div class="mt-6 bg-white rounded-2xl border border-[#E5E5EA] shadow-lg p-6 animate-slide-up relative">
                    
                    <div class="absolute -top-3 left-6 bg-white p-1 rounded-full border border-[#E5E5EA]">
                        <div class="size-6 bg-gradient-to-br from-[#0066CC] to-[#00C7BE] rounded-full flex items-center justify-center">
                            @if(!aiState.response.products || aiState.response.products.length === 0) {
                                <span class="material-symbols-outlined text-white text-[14px]">forum</span>
                            } @else {
                                <span class="material-symbols-outlined text-white text-[14px]">smart_toy</span>
                            }
                        </div>
                    </div>

                    <div class="prose prose-sm max-w-none text-[#1D1D1F] whitespace-pre-line leading-relaxed"
                         [class.mb-6]="aiState.response.products && aiState.response.products.length > 0">
                        {{ aiState.response.replySuggestion }}
                    </div>

                    @if(aiState.response.products && aiState.response.products.length > 0) {
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-4 border-t border-gray-100">
                            @for(part of aiState.response.products; track part.id) {
                                <div class="flex items-center gap-3 p-3 rounded-xl border border-[#E5E5EA] bg-white hover:border-[#0066CC] hover:shadow-md transition-all group">
                                    
                                    <div class="size-14 bg-white rounded-lg border border-[#E5E5EA] p-1 flex items-center justify-center shrink-0 overflow-hidden">
                                        <img [src]="part.imageUrl || 'https://placehold.co/150x150?text=No+Image'" class="max-w-full max-h-full object-contain mix-blend-multiply group-hover:scale-110 transition-transform">
                                    </div>
                                    
                                    <div class="flex-1 min-w-0">
                                        <div class="flex justify-between items-start">
                                            <div class="font-bold text-sm truncate text-[#1D1D1F]">{{ part.code }}</div>
                                            @if(part.price) {
                                                <div class="text-xs font-bold text-[#0066CC]">{{ part.price | currency:'TRY':'symbol-narrow' }}</div>
                                            }
                                        </div>
                                        
                                        <div class="text-xs text-gray-500 truncate" title="{{part.name}}">{{ part.name }}</div>
                                        
                                        <div class="text-[10px] mt-1 font-medium flex items-center gap-1"
                                             [class.text-green-600]="part.stockStatus === 'Stokta Var'"
                                             [class.text-red-500]="part.stockStatus === 'Stokta Yok'">
                                            <span class="size-1.5 rounded-full" 
                                                  [class.bg-green-600]="part.stockStatus === 'Stokta Var'"
                                                  [class.bg-red-500]="part.stockStatus === 'Stokta Yok'"></span>
                                            {{ part.stockStatus }}
                                        </div>
                                    </div>
                                    
                                    @if(part.catalogId) {
                                        <button (click)="openCatalog(part.catalogId)" 
                                                class="opacity-0 group-hover:opacity-100 text-[#0066CC] text-xs font-bold bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100 hover:bg-[#0066CC] hover:text-white transition-all whitespace-nowrap">
                                            Git
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    }

                    @if(aiState.response.debugInfo) {
                        <div class="mt-4 pt-4 border-t border-gray-100 text-[10px] text-gray-400 font-mono flex items-center gap-2">
                            <span class="material-symbols-outlined text-[12px]">terminal</span>
                            <span>{{ aiState.response.debugInfo }}</span>
                        </div>
                    }
                </div>
            }

            @if(!aiState.isActive) {
                <div class="mt-6 flex flex-wrap justify-center gap-2 text-xs font-medium text-[#86868B]">
                    <span>Örnekler:</span>
                    <span class="cursor-pointer hover:text-[#0066CC] hover:bg-[#E5E5EA] px-2 py-1 rounded transition-colors" (click)="searchText='Juki 1595 yağ pompası'; startAiSearch()">Juki 1595</span>
                    <span class="cursor-pointer hover:text-[#0066CC] hover:bg-[#E5E5EA] px-2 py-1 rounded transition-colors" (click)="searchText='3101801'; startAiSearch()">3101801</span>
                </div>
            }
        </div>
        
        <div class="absolute top-0 left-0 w-full h-full opacity-30 pointer-events-none bg-[radial-gradient(circle_at_top,_var(--tw-gradient-stops))] from-blue-50 via-transparent to-transparent"></div>
    </section>

    <main class="flex-1 max-w-[1600px] mx-auto w-full px-6 py-10">
        
        <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 pb-4 border-b border-[#D2D2D7] gap-4">
            
            <div class="flex-1">
                @if (!aiState.isActive) {
                    <h2 class="text-2xl font-bold text-[#1D1D1F] tracking-tight">Kataloglarımız</h2>
                    <p class="text-sm text-[#86868B] mt-1">Tüm yedek parça kataloglarını inceleyin.</p>
                } 
                @else {
                    <h2 class="text-2xl font-bold text-[#1D1D1F] flex items-center gap-2">
                        @if(aiState.response && (!aiState.response.products || aiState.response.products.length === 0)) {
                            <span>Sohbet Asistanı</span>
                        } @else {
                            <span>Yapay Zeka Sonuçları</span>
                        }
                    </h2>
                }
            </div>
        </div>

        @if (isLoading) {
            <div class="flex flex-col items-center justify-center py-32">
                <span class="material-symbols-outlined animate-spin text-4xl text-[#0066CC] mb-4">progress_activity</span>
                <p class="text-[#86868B] font-medium text-sm">Kataloglar yükleniyor...</p>
            </div>
        }
        @else {
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                
                @for (item of visibleCatalogs; track item.id) {
                    <div (click)="openCatalog(item.id)" class="group bg-white rounded-2xl border border-[#D2D2D7] hover:border-[#0066CC] hover:shadow-xl cursor-pointer overflow-hidden flex flex-col transform hover:-translate-y-1 transition-all duration-300">
                        <div class="aspect-[16/9] bg-[#F5F5F7] relative overflow-hidden border-b border-[#F5F5F7]">
                            <img [src]="item.imageUrl || 'https://placehold.co/600x400?text=No+Image'" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700 mix-blend-multiply">
                        </div>
                        <div class="p-5 flex-1">
                            <h3 class="text-[15px] font-bold mb-2 text-[#1D1D1F] group-hover:text-[#0066CC] transition-colors">{{ item.name }}</h3>
                            <p class="text-[12px] text-[#86868B] line-clamp-2">{{ item.description || 'Açıklama yok.' }}</p>
                        </div>
                    </div>
                }
                
                @if (visibleCatalogs.length === 0) {
                    <div class="col-span-full text-center py-12 text-[#86868B]">
                        <span class="material-symbols-outlined text-4xl mb-2 opacity-30">folder_off</span>
                        <p>Henüz yayınlanmış bir katalog bulunmuyor.</p>
                    </div>
                }
            </div>
        }
    </main>

    <footer class="bg-[#1D1D1F] text-[#86868B] py-12 border-t border-[#424245]">
        <div class="max-w-[1600px] mx-auto px-6 flex justify-between">
            <p>Galeri Makina - Partalog Altyapısı</p>
        </div>
    </footer>

    @if(isCartOpen) {
        <div (click)="isCartOpen = false" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 transition-opacity"></div>
    }

    <div [class.translate-x-full]="!isCartOpen" 
         class="fixed top-0 right-0 h-full w-full sm:w-[400px] bg-white shadow-2xl z-[60] transition-transform duration-300 ease-in-out flex flex-col">
        
        <div class="px-6 py-4 border-b border-[#E5E5EA] flex items-center justify-between bg-[#FAFAFA]">
            <h3 class="text-lg font-bold text-[#1D1D1F]">Sepetim</h3>
            <button (click)="isCartOpen = false" class="text-[#86868B] hover:text-[#1D1D1F] p-1 rounded-full hover:bg-gray-200">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6">
            @if ((cartService.cart$ | async)?.length === 0) {
                <div class="h-full flex flex-col items-center justify-center text-[#86868B]">
                    <span class="material-symbols-outlined text-6xl mb-4 opacity-20">shopping_basket</span>
                    <p>Sepetiniz boş.</p>
                </div>
            }

            @for (item of cartService.cart$ | async; track item.product.catalogItemId) {
                <div class="flex items-start gap-3 mb-4 pb-4 border-b border-[#F5F5F7] last:border-0">
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-sm truncate text-[#1D1D1F]">{{ item.product.partCode }}</div>
                        <div class="text-xs text-[#666] line-clamp-1">{{ item.product.partName }}</div>
                        <div class="text-[#0066CC] font-bold text-xs mt-1">{{ item.product.price | currency:'TRY':'symbol-narrow' }}</div>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <div class="flex items-center bg-[#F2F2F7] rounded p-0.5">
                            <button (click)="cartService.updateQuantity(item.product.catalogItemId, item.quantity - 1)" class="size-6 bg-white rounded shadow-sm hover:scale-105">-</button>
                            <span class="w-6 text-center text-xs font-bold">{{ item.quantity }}</span>
                            <button (click)="cartService.addToCart(item.product)" class="size-6 bg-white rounded shadow-sm hover:scale-105">+</button>
                        </div>
                        <button (click)="cartService.removeFromCart(item.product.catalogItemId)" class="text-[#86868B] hover:text-[#FF3B30] transition-colors">
                            <span class="material-symbols-outlined text-sm">delete</span>
                        </button>
                    </div>
                </div>
            }
        </div>

        <div class="p-6 border-t border-[#E5E5EA] bg-[#FAFAFA]">
            <div class="flex justify-between items-center mb-6">
                <span class="font-bold text-[#1D1D1F]">Toplam Tutar:</span>
                <span class="font-bold text-xl text-[#0066CC]">{{ cartService.totalPrice$ | async | currency:'TRY':'symbol-narrow' }}</span>
            </div>

            <div class="space-y-3 mb-6">
                <input [(ngModel)]="customerForm.name" type="text" placeholder="Adınız Soyadınız *" class="w-full p-3 border border-[#D2D2D7] rounded-lg text-sm outline-none focus:border-[#0066CC] transition-colors">
                <input [(ngModel)]="customerForm.phone" type="tel" placeholder="Telefon Numaranız *" class="w-full p-3 border border-[#D2D2D7] rounded-lg text-sm outline-none focus:border-[#0066CC] transition-colors">
                <input [(ngModel)]="customerForm.email" type="email" placeholder="E-posta (Opsiyonel)" class="w-full p-3 border border-[#D2D2D7] rounded-lg text-sm outline-none focus:border-[#0066CC] transition-colors">
            </div>
            
            <button (click)="submitOrder()" 
                    [disabled]="isSubmitting || !customerForm.name || !customerForm.phone"
                    class="w-full py-3.5 bg-[#1D1D1F] hover:bg-black text-white rounded-xl font-bold flex items-center justify-center gap-2 disabled:bg-gray-400 transition-all shadow-lg hover:shadow-gray-500/30 transform hover:-translate-y-0.5">
                @if(isSubmitting) {
                    <span class="material-symbols-outlined animate-spin text-[20px]">progress_activity</span>
                    <span>İşleniyor...</span>
                } @else {
                    <span class="material-symbols-outlined text-[20px]">check_circle</span>
                    <span>Siparişi Onayla</span>
                }
            </button>
        </div>
    </div>
</div>